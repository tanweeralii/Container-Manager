<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
		<script>
			if(localStorage.uname == undefined){
				window.location = window.location.href+"login";
			}
		</script>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css?family=Mansalva&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Titillium+Web&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="scripts/reset.css">
	<link rel="stylesheet" href="scripts/style.css" media="screen" type="text/css" />
	<title>Upload Files</title>
    </head>
    <body>
        <div class="wrap">
		<div class="avatar">
      			<img src="https://img.icons8.com/windows/32/000000/docker.png"/>
		</div>
		<div class="custom-select" style="width:350px;">
            <select id="containers_id">
            	<option value="0">Select Container</option>
            </select>
		</div>
		</br>
		<input id="upload_file_" type="file" name="upload_file" multiple="multiple" required/>
		</br>
		<form id="myform" enctype="multipart/form-data" method="POST">
			<div class="bar">
				<i></i>
			</div>
			<input id="fillthis" type="hidden" required>
			<input id="path" type="path" placeholder="/home/foo/bar" name="path_in_container" required> 
        	<button type="submit">Upload</button>
		</form>
		<div class="progress">
            <div class="progress-bar" role="progressbar"></div>
		</div>
		<p id="printDirectoriesHere"></p>
	</div>
	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script>
		$.post('list_running_containers',function(req,res){
	    	var obj = JSON.parse(req.message);
	        obj.forEach((message) => {
				var result = message.Id.slice(0, 12).trim();
				console.log(result);
				console.log(message.Image + "-" + result);
				$("#containers_id").append($("<option />").val(result).text(message.Image + "-" + result));
			})
			var x, i, j, l, ll, selElmnt, a, b, c;
			/* Look for any elements with the class "custom-select": */
			x = document.getElementsByClassName("custom-select");
			l = x.length;
			console.log("ready_first");
			for (i = 0; i < l; i++) {
  				selElmnt = x[i].getElementsByTagName("select")[0];
  				ll = selElmnt.length;
  				/* For each element, create a new DIV that will act as the selected item: */
  				a = document.createElement("DIV");
  				a.setAttribute("class", "select-selected");
  				a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
  				x[i].appendChild(a);
  				/* For each element, create a new DIV that will contain the option list: */
  				b = document.createElement("DIV");
 	 			b.setAttribute("class", "select-items select-hide");
  				for(j = 1; j < ll ;j++) {
    					c = document.createElement("DIV");
    					c.innerHTML = selElmnt.options[j].innerHTML;
    					c.addEventListener("click", function(e) {
        					/* When an item is clicked, update the original select box,
        					and the selected item: */
        					var y, i, k, s, h, sl, yl;
        					s = this.parentNode.parentNode.getElementsByTagName("select")[0];
        					sl = s.length;
        					h = this.parentNode.previousSibling;
        					for (i = 0; i < sl; i++) {
          						if (s.options[i].innerHTML == this.innerHTML) {
            							s.selectedIndex = i;
            							h.innerHTML = this.innerHTML;
            							y = this.parentNode.getElementsByClassName("same-as-selected");
            							yl = y.length;
            							for (k = 0; k < yl; k++) {
              								y[k].removeAttribute("class");
            							}
            							this.setAttribute("class", "same-as-selected");
            							break;
          						}
        					}
        					h.click();
    					});
    					b.appendChild(c);
  				}
  				x[i].appendChild(b);
  				a.addEventListener("click", function(e) {
    					/* When the select box is clicked, close any other select boxes,
    					and open/close the current select box: */
    					e.stopPropagation();
    					closeAllSelect(this);
    					this.nextSibling.classList.toggle("select-hide");
						this.classList.toggle("select-arrow-active");
						var container_name = $(".select-selected").text();
						var container_name_ = container_name.slice(container_name.length-12);
						console.log(container_name_);
						$("#fillthis").val(container_name_);
  				});
			}
		});
		function closeAllSelect(elmnt) {
  			/* A function that will close all select boxes in the document,
  			except the current select box: */
  			var x, y, i, xl, yl, arrNo = [];
  			x = document.getElementsByClassName("select-items");
  			y = document.getElementsByClassName("select-selected");
  			xl = x.length;
  			yl = y.length;
  			for (i = 0; i < yl; i++) {
    				if (elmnt == y[i]) {
      					arrNo.push(i)
    	 			} else {
      					y[i].classList.remove("select-arrow-active");
    				}
  			}
  			for (i = 0; i < xl; i++) {
    				if (arrNo.indexOf(i)) {
      					x[i].classList.add("select-hide");
    				}
  			}
		}
		/* If the user clicks anywhere outside the select box,
		then close all select boxes: */
		$("#path").keypress(function(event){
			if(event.which==47){
				var formData = new FormData();
				formData.append("id_of_container",$("#fillthis").val());
				formData.append("current_directory",$("#path").val());
				$.ajax({
                	url: '/ListDirectories',
                	type: 'POST',
            		data: formData,
                	processData: false,
                	contentType: false,
                	success: function(data){
						var result = data.message;
						var final = result.split("\n").join("<br>");
						console.log(result);
						$("#printDirectoriesHere").html(final);
            		},
            	});
			}
		});
		document.addEventListener("click", closeAllSelect);
		$('.progress-bar').text('0%');
    	$('.progress-bar').width('0%');
		$("form#myform").submit(function(e) {
			console.log("hello")
    		e.preventDefault();
			e.stopPropagation();
			var file_data = $('input[type="file"]')[0].files;
			var formData = new FormData();
			for(var i = 0;i<file_data.length;i++){
				formData.append("upload_file", file_data[i], file_data[i].name);
				console.log(file_data[i].name);
			}
			console.log("File packed");
			var other_data = $(this).serializeArray();
			console.log(other_data);
			$.each(other_data,function(key,input){
				formData.append(input.name,input.value);
			});
			formData.append("id_of_container",$("#fillthis").val());
			console.log($("#fillthis").val());
			console.log("Everything ready to send");
            $.ajax({
                url: '/upload',
                type: 'POST',
            	data: formData,
                processData: false,
                contentType: false,
                success: function(data){
                	console.log('upload successful!\n' + data);
					$("#myform").trigger("reset");
                	alert(data.message)
            	},
                xhr: function() {
                    var xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(evt) {
                        if (evt.lengthComputable) {
                        	var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);
                            $('.progress-bar').text(percentComplete + '%');
                            $('.progress-bar').width(percentComplete + '%');
                        	if (percentComplete === 100) {
                            	$('.progress-bar').html('Done');
                            }
                        }
                    }, false);
                	return xhr;
		        }
            });
		});		
	</script>
    </body>
</html>
